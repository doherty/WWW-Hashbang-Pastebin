#!/opt/perl5/perls/perl-5.16.3/bin/perl
use strict;
use warnings;
# VERSION
# PODNAME: pastebin
# ABSTRACT: init script for WWW::Hashbang::Pastebin

use Daemon::Control;
use Path::Tiny;

=head1 SYNOPSIS

    pastebin [start|stop|restart|status]

=for test_synopsis
1;
__END__

=cut

my $user = my $group = 'www-data';

my $run_dir = path(qw( / var run www-data-daemons ));
unless ( -d $run_dir ) {
    mkdir $run_dir;
    chown scalar getpwnam($user), scalar getgrnam($group), $run_dir;
}

Daemon::Control->new({
    name        => 'pastebin',
    program     => path(qw( / opt perl5 perls perl-5.16.3 bin plackup )),
    program_args=> [
        '-s' => 'Starman',
        '-E' => 'production',
        '-S' => path( $run_dir, 'pastebin.sock' ),
        '-I' => path(qw( / var www p.hashbang.ca WWW-Hashbang-Pastebin lib )),
        '-a' => path(qw( / var www p.hashbang.ca WWW-Hashbang-Pastebin bin app.pl )),
        map { ('-M' => $_) } qw/ DBIx::Class /,
    ],
    fork        => 2,
    user        => $user,
    group       => $group,
    pid_file    => path( $run_dir, 'pastebin.pid' ),
    stdout_file => path( $run_dir, 'pastebin.log' ),
    stderr_file => path( $run_dir, 'pastebin.log' ),

    lsb_start   => '$nginx',
    lsb_stop    => '$nginx',
    lsb_sdesc   => 'Starts Starman running WWW::Hashbang::Pastebin',
    lsb_desc    => 'Starts Starman running WWW::Hashbang::Pastebin',
})->run;
